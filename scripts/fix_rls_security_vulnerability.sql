-- =====================================================
-- CRITICAL SECURITY FIX: RESTRICT WRITE ACCESS FOR VIEWERS
-- =====================================================
-- Vulnerability: Previous policies allowed "Viewers" (Mentors) to INSERT/UPDATE/DELETE 
--                hives and tasks because the policy used 'FOR ALL'.
-- Fix:           Split policies into:
--                1. 'FOR SELECT' -> Allow Owners OR Viewers
--                2. 'FOR ALL' (Write) -> Allow Owners ONLY
-- DATE:          2026-01-25
-- =====================================================

-- -----------------------------------------------------
-- 1. HIVES TABLE
-- -----------------------------------------------------

-- Drop the insecure policy
DROP POLICY IF EXISTS "Access hives via apiary ownership or share" ON hives;
DROP POLICY IF EXISTS "Users exclude delete via apiary ownership or share" ON hives; -- Cleanup old attempts if any

-- A) READ ACCESS (Owners + Viewers)
CREATE POLICY "Read hives via apiary ownership or share" ON hives
FOR SELECT
TO authenticated
USING (
    EXISTS (
        SELECT 1 FROM apiaries a
        LEFT JOIN apiary_shares s ON s.apiary_id = a.id AND s.viewer_id = auth.uid()
        WHERE a.id = hives.apiary_id
        AND (
            a.user_id = auth.uid() -- Owner
            OR s.id IS NOT NULL    -- Shared Viewer
        )
    )
);

-- B) WRITE ACCESS (Owners Only)
-- Covers INSERT, UPDATE, DELETE
CREATE POLICY "Manage hives via apiary ownership" ON hives
FOR ALL
TO authenticated
USING (
    EXISTS (
        SELECT 1 FROM apiaries a
        WHERE a.id = hives.apiary_id
        AND a.user_id = auth.uid() -- STRICT OWNER CHECK
    )
)
WITH CHECK (
    EXISTS (
        SELECT 1 FROM apiaries a
        WHERE a.id = hives.apiary_id
        AND a.user_id = auth.uid() -- STRICT OWNER CHECK
    )
);


-- -----------------------------------------------------
-- 2. TASKS TABLE
-- -----------------------------------------------------

-- Drop the insecure policy
DROP POLICY IF EXISTS "Access tasks via apiary ownership, share, or assignment" ON tasks;

-- A) READ ACCESS (Owners + Viewers + Assignees)
CREATE POLICY "Read tasks via ownership, share, or assignment" ON tasks
FOR SELECT
TO authenticated
USING (
    -- 1. Owner
    EXISTS (
        SELECT 1 FROM apiaries a
        WHERE a.id = tasks.apiary_id 
        AND a.user_id = auth.uid()
    )
    OR
    -- 2. Viewer
    EXISTS (
        SELECT 1 FROM apiary_shares s
        WHERE s.apiary_id = tasks.apiary_id 
        AND s.viewer_id = auth.uid()
    )
    OR
    -- 3. Directly Assigned
    assigned_user_id = auth.uid()
);

-- B) WRITE ACCESS (Owners Only + Self-Assigned)
-- We restrict Viewers from creating/deleting tasks in the Owner's apiary.
-- Owners can manage all. Users can manage tasks assigned to them (optional, but requested behavior implied ownership control).
-- For strict security: Owners Only.
CREATE POLICY "Manage tasks via apiary ownership" ON tasks
FOR ALL
TO authenticated
USING (
    EXISTS (
        SELECT 1 FROM apiaries a
        WHERE a.id = tasks.apiary_id 
        AND a.user_id = auth.uid()
    )
    -- Optional: If you want Assignees to be able to complete tasks (Update), you'd need a separate UPDATE policy.
    -- For now, locking it to Owners prevents Mentors from deleting tasks.
);


-- -----------------------------------------------------
-- 3. HIVE SNAPSHOTS TABLE (Inspections/History)
-- -----------------------------------------------------

-- Drop restrictive or permissive policies if needed (snapshot policies often tricky)
-- Ensure INSERT is Owner Only (BarVisualizer capture)

DROP POLICY IF EXISTS "Users can insert snapshots of own hives" ON hive_snapshots;

CREATE POLICY "Users can insert snapshots of own hives" ON hive_snapshots
FOR INSERT
TO authenticated
WITH CHECK (
    EXISTS (
        SELECT 1 FROM hives h
        JOIN apiaries a ON a.id = h.apiary_id
        WHERE h.id = hive_snapshots.hive_id
        AND a.user_id = auth.uid() -- STRICT OWNER CHECK
    )
);

-- (Read access for snapshots is typically handled by a SELECT policy that mirrors Hives)
-- Ensuring READ policy exists (Owners + Viewers)
DROP POLICY IF EXISTS "Read snapshots via hive access" ON hive_snapshots;
CREATE POLICY "Read snapshots via hive access" ON hive_snapshots
FOR SELECT
TO authenticated
USING (
    EXISTS (
        SELECT 1 FROM hives h
        JOIN apiaries a ON a.id = h.apiary_id
        LEFT JOIN apiary_shares s ON s.apiary_id = a.id AND s.viewer_id = auth.uid()
        WHERE h.id = hive_snapshots.hive_id
        AND (
            a.user_id = auth.uid() -- Owner
            OR s.id IS NOT NULL    -- Shared Viewer
        )
    )
);


SELECT 'CRITICAL FIX APPLIED: Viewers (Mentors) are now reduced to READ-ONLY access for Hives, Tasks, and Snapshots.' as message;
